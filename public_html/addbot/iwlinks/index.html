<?php
include("../../buildpage.php");
$start_time = MICROTIME(TRUE);

//get the language option
$q = "";
$t = "";
$STATE = "";
if(isset($_GET['lang']))
{
	$q = "SELECT article,links,checked FROM iwlink	WHERE lang='".$_GET['lang']."' ORDER BY links DESC LIMIT 50";
	$t = "List of articles where links remain on ".$_GET['lang'];
	$STATE = "ARTICLES";
	if(isset($_GET['offset']))
	{
		$q = $q." OFFSET ".$_GET['offset'];
	}
}
else
{
	$q = "SELECT lang,count(*) as remain from iwlink WHERE links!='' group by lang order by remain DESC";
	$t = "List of langs with links left";
	$STATE = "LANGS";
}

//database
require '../../../classes/database.php';
require '../../../config/database.php';

//db
$db = new Database( $config['dbhost'], $config['dbport'], $config['dbuser'], $config['dbpass'], $config['dbname'], false);
unset($config['dbpass']);
$res = Database::mysql2array($db->doQuery($q));

//output to html page
$out = "";

if($STATE == "LANGS")
{
//count the total number we have in the DB
$resall = Database::mysql2array($db->doQuery("SELECT lang,count(*) as remain from iwlink GROUP BY lang"));

//claculate total number remaining
$total = 0;
//foreach where links !="" as $r
foreach ($res as $r)
{
	$total = $total + intval($r['remain']);
}
$all = 0;
foreach ($resall as $r)
{
	$all = $all + intval($r['remain']);
}

$out .="<p>For a history of this list please see <a href='http://meta.wikimedia.org/w/index.php?title=User:Addbot/Interwiki_Status&action=history'> the list on meta</a>.</p>\n";
$out .="<p>Total in DB = ".number_format($all,0,'.',',').", ";
$out .="Total bot checked = ".number_format($total,0,'.',',').", ";
$out .="Total to go= ".number_format($all - $total,0,'.',',')."</p>\n";

$out .= "<div><table><tr><th>Language</th><th>Pending</th><th>Checked*</th></tr>\n";
$alllang ="|nostalgia|ten|aa|ab|ace|af|ak|als|am|an|ang|ar|arc|arz|as|ast|av|ay|az|ba|bar|bcl|be|bg|bh|bi|bjn|bm|bn|bo|bpy|br|bs|bug|bxr|ca|cdo|ce|ceb|ch|cho|chr|chy|ckb|co|cr|crh|cs|csb|cu|cv|cy|da|de|diq|dsb|dv|dz|ee|el|eml|en|eo|es|et|eu|ext|fa|ff|fi|fj|fo|fr|frp|frr|fur|fy|ga|gag|gan|gd|gl|glk|gn|got|gu|gv|ha|hak|haw|he|hi|hif|ho|hr|hsb|ht|hu|hy|hz|ia|id|ie|ig|ii|ik|ilo|io|is|it|iu|ja|jbo|jv|ka|kaa|kab|kbd|kg|ki|kj|kk|kl|km|kn|ko|koi|kr|krc|ks|ksh|ku|kv|kw|ky|la|lad|lb|lbe|lez|lg|li|lij|lmo|ln|lo|lt|ltg|lv|mdf|mg|mh|mhr|mi|min|mk|ml|mn|mo|mr|mrj|ms|mt|mus|mwl|my|myv|mzn|na|nah|nap|nds|	ne|new|ng|nl|nn|no|nov|nrm|nso|nv|ny|oc|om|or|os|pa|pag|pam|pap|pcd|pdc|pfl|pi|pih|pl|pms|pnb|pnt|ps|pt|qu|rm|rmy|rn|ro|ru|rue|rw|sa|sah|sc|scn|sco|sd|se|sg|sh|si|simple|sk|sl|sm|sn|so|sq|sr|srn|ss|st|stq|su|sv|sw|szl|ta|te|tet|tg|th|ti|tk|tl|tn|to|tpi|tr|ts|tt|tum|tw|ty|udm|ug|uk|ur|ve|vec|vep|vi|vls|vo|wa|war|wo|wuu|xal|xh|xmf|yi|yo|za|zea|zh|zu|";
//for every lang in the db
foreach ($resall as $r)
{
	$alllang = str_replace('|'.$r['lang'].'|',"|",$alllang); 
	$checked = 0;
	//foreach where links !="" as $rt
	foreach ($res as $rt)
	{
		if($rt['lang'] == $r['lang'])
		{
			$checked = $rt['remain'];
		}
	}
	$pending = $r['remain']-$checked;
	
	$out .= "<tr><td><a href='index.html?lang=".$r['lang']."'>".$r['lang'].".wikipedia</a></td><td>".number_format($pending,0,'.',',')."</td><td>".number_format($checked,0,'.',',')."</td></tr>\n";
}
$out .= "</table></div>";
$out.= "* 'Checked' referes to the count of articles that the bot has chcked at least once<br>\n";
$out .= "Languages complete include $alllang</br>";

}
else if ($STATE == "ARTICLES")
{

$url = "http://tools.wmflabs.org/addshore/addbot/iwlinks/index.html?lang=".$_GET['lang'];
$out .= "Pick an offset for the list (";
for($i = 0; $i <= 10; $i++)
{
	$c = 50*$i;
	$out .= "<a href='$url&offset=$c'>$c</a>, ";
} 
$out = trim($out,', ');
$out .= ")</br>\n";

$out .= "\n<div><table><tr><th>Article</th><th>Wikidata</th><th>Links</th><th>Last Checked*</th></tr>\n";
foreach ($res as $r)
{
	//check if the article already has a wikidata entry
	$out .= "<tr><td><a href='https://".$_GET['lang'].".wikipedia.org/wiki/".$r['article']."'>".$r['article']."</a></td>";
	$out .= "<td><a href='https://www.wikidata.org/wiki/Special:ItemByTitle/".$_GET['lang']."wiki/".$r['article']."'>LINK</a></td>";
	$out .= "<td>".$r['links']."</td>";
	$out .= "<td>".$r['checked']."</td></tr>\n";
}
$out .= "</table></div>";

$out.= "* 'Last Checked' referes to the date that the bot last attempted to remove links from the article<br>\n";

}

//calculations
$stop_time = MICROTIME(TRUE);
$time = $stop_time - $start_time;

//add the header(in reverse order)
//$out = "The lists will slowly be updated by the bot as pages are constantly being rechecked!</br>\n".$out;
$out = "<p>This page contains lists of articles that still have interwiki links according to Addbot! <small>(Take a look at <a href='http://tools.wmflabs.org/addshore/addbot/status'>My Status</a>)</small></p>\n".$out;
$out = "<h1>Remaining Interwikis</h1>\n".$out;
$out = "<html>".getHeader("Remaining Interwikis")."<body>\n".getSideBar().'</br><div id="content-column">'.$out;
//add the footer
$out .= "<small>Elapsed time was $time seconds.</small>";
$out .= "</div></body></html>";
//output
echo $out;

?>
