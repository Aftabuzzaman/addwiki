<?PHP
include(__DIR__."/../buildpage.php");
$header = "<html>".getHeader("CSDF8 Comparison")."<body>".getSideBar()."<div id='content-column'>
<h1>CSDF8 Tool</h1>";
$footer = "</div></body></html>";

//Wiki instance
require __DIR__.'/../../classes/botclasses.php';
$wiki = new wikipedia;
$wiki->url = 'http://en.wikipedia.org/w/api.php';
global $wiki;

$cat = 'Category:Wikipedia files with the same name on Wikimedia Commons';

//Output the first page asking for a number of files to compare
if(!isset($_GET['toget']) || !is_numeric($_GET['toget']))
{

	//Get a list of possible cats
	$cats = $wiki->categorymembers($cat,false);
	$selection = "<option value='$cat'>$cat</option>";
	foreach($cats as $c)
	{
		$selection .= "<option value='$c'>$c</option>";
	}
	
	//output the page
	echo $header;
	echo "<p>This tool very hackily loads $cat and compares the file version on enwiki along side the same file on commons while highlighting certain words in each files description, this allows admins to easily spot identical files with the correct permissions on both sites to be deleted from enwiki</p>";
	echo "<form action='index.html' method='get'>
	Category to get files from:
	<select name='category'>
	$selection
	</select></br>
	Number of files to compare: <input type='text' name='toget'>
	<input type='submit'>
	</form>";
	echo "<p>Files are taken from $cat</p>";
	echo $footer;
}
//Output the results
else
{

	$header .= "<h2>".$_GET['category']."</h2><ul>";
	$footer = "</ul>".$footer;
	echo $header;
	
	require __DIR__.'/../../classes/wikitexttohtml.php';

	$comm = new wikipedia;
	$comm->url = 'http://commons.wikimedia.org/w/api.php';
	global $comm;

	$cat = $_GET['category'];
	$files = $wiki->categorymembers($cat,true);
	$counter = 0;

	//Content creation
	foreach ($files as $file)
	{
		if($counter <$_GET['toget'] && strstr($file,"Category:") == false)
		{
			$counter++;
			$wi = $wiki->getfilethumblocation($file,100);
			$ci = $comm->getfilethumblocation($file,100);			
			$wu = $wiki->getfileuploader($file);
			$cu = $comm->getfileuploader($file);
			$wimg = "<img align='left' src='$wi' alt='$file' height='100' width='100'>";
			$cimg = "<img align='left' src='$ci' alt='$file' height='100' width='100'>";
			$wp = $wiki->getpage($file);
			$cp = $comm->getpage($file);
			$wp = preg_replace("/(\{\{(cc|puf|pui(disputed)|imagevio)|PD|GFDL|self|Non|public domain|delete)/i","<b>$0</b>",$wp);
			$cp = preg_replace("/(\{\{(cc|puf|pui(disputed)|imagevio)|PD|GFDL|self|Non|$wu|public domain|User:|delete)/i","<b>$0</b>",$cp);
			$wp = preg_replace("/(\{\{(puf|pui(disputed)|imagevio))/i","<font color='red'>$0</font>",$wp);
			$cp = preg_replace("/(\{\{(puf|pui(disputed)|imagevio))/i","<font color='red'>$0</font>",$cp);
			
			echo "<li><a target='_blank' href='http://en.wikipedia.org/w/index.php?title=$file&action=delete&wpReason=CSDF8'><b>Delete</b></a>";
			echo "<table border='0' width='100%'><col width='50%'><col width='50%'>";
			echo "<tr><td>$wimg <a target='_blank' href='http://en.wikipedia.org/wiki/$file'>Wikipedia:$file </a> by <b>$wu</b></td><td>$cimg <a target='_blank' href='$ci'>Commons:$file </a> by $cu</td></tr>";
			echo "<tr><td>$wp</td><td>$cp</td></tr>";
			echo "</table>";
		}
	}
	//did we actually get anything for the page?
	if($counter == 0)
	{
		echo "It appears that this category is empty...</br>";
		echo "<a href='//en.wikipedia.org/wiki/$cat'>Category</a> - <a href='//en.wikipedia.org/w/index.php?title=$cat&action=delete&wpReason=".urlencode("[[WP:CSD#C1|C1]]: Empty Category")."'>Delete</a></br><p>The script returned...</p>";
		print_r($files);
	}

	print $footer;
}
?>